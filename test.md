# 标准化部署方案


## issues

-   对网络带宽的要求?  
    -   设置亲和性, 什么应用需要和尽可能的部署在同一个host里面

-   依赖的中间件应该都在清单中列出来

-   共享  
    -   具体共享给多少个应用, 目前不知道
-   独占  
    -   为什么要用独占

-   performants  
    -   throughput  
        -   对于单用户的系统，响应时间可以很好地度量系统的性能，但对于并发系统，通常需要用吞吐量作为性能指标
        -   回答在一定的用户规模下系统的处理能力
    -   tps/qps  
        -   一般用qps来衡量接口的查询效率
        -   一般用tps来衡量整个业务流程  
            -   金融行业：1000TPS~50000TPS，不包括互联网化的活动
            -   保险行业：100TPS~100000TPS，不包括互联网化的活动
            -   制造行业：10TPS~5000TPS
            -   互联网电子商务：10000TPS~1000000TPS
            -   互联网中型网站：1000TPS~50000TPS
            -   互联网小型网站: 500TPS~10000TPS
    -   rt  
        -   不同的行业,不同的业务类型需要的指标是不一样的  
            -   互联网企业：500 毫秒以下，例如淘宝业务 10 毫秒左右。
            -   金融企业：1 秒以下为佳，部分复杂业务 3 秒以下。
            -   保险企业：3 秒以下为佳。
            -   制造业：5 秒以下为佳
        -   批处理任务的时间窗口  
            -   比如 承诺在 2h 之内完成
    
    -   典型场景下的最大并发用户数  
        -   用户不同的使用模式会导致不同用户在单位时间发出不同数量的请求
    
    -   错误率  
        -   指系统在负载情况下，失败交易的概率。错误率＝(失败交易数/交易总数)\*100%

-   针对java应用的性能指标  
    -   不允许出现full gc的情况


## 版本计划

-   图


## 进项标准部署方案

-   云  
    -   概念定义: 标准服务和二开的服务都在云励自己的云上
    -   缺一张部署架构图
    -   分为3档  
        -   基本档  
            -   SLA: 产品可用最低标准 (50万/年)
            -   资源成本  
                -   成本可忽略
            -   人员成本 (只考虑部署带来的成本)  
                -   无成本
        -   中档  
            -   SLA: 满足中小微企业的开票需求 (100万/年)
            -   资源成本  
                -   成本可忽略
            -   人员成本 (只考虑部署带来的成本)  
                -   无成本
        -   高档  
            -   SLA: 满足中等规模以上企业的日常开票需求 (500万/年)
            -   资源成本  
                -   成本可忽略
            -   人员成本 (只考虑部署带来的成本)  
                -   无成本
-   大属地  
    -   概念定义: 标准服务和二开的服务都在客户提供的硬件资源上
    -   缺一张部署架构图
    -   分为3档  
        -   基本档  
            -   SLA: 产品可用最低标准 (50万/年) 对标阳关城
            -   资源成本  
                -   由客户方提供 (需要 52C/137Gb/2.4T)
                -   这里插入一个表格
            -   人员成本 (只考虑部署带来的成本)  
                -   部署成本 (86个人/天)
        -   中档  
            -   SLA: 满足中小微企业的开票需求 (100万/年)
            -   资源成本  
                -   由客户方提供 (需要 52C/137Gb/2.4T) \* max(1.5)
                -   这里插入一个表格
            -   人员成本 (只考虑部署带来的成本)  
                -   部署成本 (86个人/天)
        -   高档  
            -   SLA: 满足中等规模以上企业的日常开票需求 (500万/年)
            -   资源成本  
                -   由客户方提供 (需要 52C/137Gb/2.4T) \* max(2)
                -   这里插入一个表格
            -   人员成本 (只考虑部署带来的成本)  
                -   部署成本 (86个人/天)
-   精益属地  
    -   概念定义: 标准服务在云励提供的, 二开的服务部署在客户方提供的硬件资源上
    -   缺一张部署架构图
    -   分为3档  
        -   基本档  
            -   SLA: 产品可用最低标准 (50万/年)
            -   资源成本  
                -   由客户方提供 (需要 16C/24G/1T)
                -   这里插入一个表格
            -   人员成本 (只考虑部署带来的成本)  
                -   部署成本 (20人/天)
        -   中档  
            -   SLA: 满足中小微企业的开票需求 (100万/年)
            -   资源成本  
                -   由客户方提供 (需要 16C/24G/1T) \* max(1.5)
                -   这里插入一个表格
            -   人员成本 (只考虑部署带来的成本)  
                -   部署成本 (20人/天)
        -   高档  
            -   SLA: 满足中等规模以上企业的日常开票需求 (500万/年)
            -   资源成本  
                -   由客户方提供 (需要 16C/24G/1T) \* max(2)
                -   这里插入一个表格
            -   人员成本 (只考虑部署带来的成本)  
                -   部署成本 (20人/天)


## 目标

-   给售前/解决方案提供一个 **工具**, 使其能根据客户的需求快速的产生一份部署清单  
    -   该部署清单能及时给予反馈 (比如这种模式背后的成本有多大), 作为交付方案决策的参考依据
    -   通过该部署清单的流程进行协同, 以及确定背后的成本
-   该部署清单作为输入项给到产研, 据此不断优化部署方案  
    -   提高部署的效率, 降本增效
    -   标准化后才能进行更高程度的自动化


## RoadMap


### 版本变更

| release   | changeSet |
| ---       | ---       |
| v21.10.20 | Draft     |
| v21.10.22 | 流程      |


### 待办事项

-   [X] 梳理当前部署的现状
-   [ ] 我们期望的部署是什么样子的
-   [ ] 当我们在谈论部署这件事的时候, 我们讨论的 **模型** 是什么
-   [ ] 以 **进项** 作为项目来进行使用
-   [ ] 推广铺开到其他的产线, 不断完善标准部署模型
-   [ ] 除了文档之外, 计划提供一个预览页面, 根据不同的选择实时计算大致的预算


### 推进计划

-   第一迭代 [2021/09/26]  
    -   工作重点:  
        按照当前运维动作, 整理出一份部署清单文档
    -   产出  
        -   按照3种模式进行整理  
            -   云部署方案
            -   大属地部署方案
            -   精益属地部署方案
        -   每个小节内容输出包含  
            -   部署架构图
            -   提供workload估算相对应的硬件费用/人力支持成本  
                -   按照 **高中低** 三个标准套餐微服务部署
                -   每个套餐下对应的人力成本
        -   其他相应解决方案, 提供一个标准套餐(以及每个套餐对应的费用/人力成本)  
            -   监控
            -   日志归档
            -   属地数据同步方案
            -   API对接的套餐

-   第二个迭代 [2021/10/06]  
    -   工作重点:  
        -   梳理进项产品标准化部署的套餐
        -   以及开放给客户的功能和性能的选项  
            -   基于应用维度来 (注意有依赖关系)
            -   对性能的预估, 反过来对应用的容量有要求
    -   产出  
        -   进项产品的部署选项模型, 以及对应的成本预算  
            -   列出一共有多少个微服务
        -   并用该模型对比目前的线上的差异分析

-   第三个迭代 [2021/10/13]  
    -   工作重点:  
        -   对销项/协同进行标准化部署的梳理
    -   产出  
        -   销项/协同产品标准化部署文档以及提供的选项

-   第四个迭代 [2021/10/31]  
    -   工作重点:  
        -   部署模型工作机制的制定与推  
            -   控制反转,变成一个依赖项, 后续其他团队如果有新的功能/性能的选项时候反过来找到标准化部署来进行更新
        -   将上述标准化的部署做成一个产品, 用户自主进行使用
        -   进行部署清单的自动化管理 (包括创建/审批/变更)
    -   产出  
        -   一个内部协同的工具
        -   孵化出一套不团迭代的流程


## 概念对齐

-   中间件  
    -   这里的中间件包括DB/MQ/监控产品等产品, 不直接对最终用户提供服务
-   应用  
    -   应用包括实现业务的微应用, 或者纯前端的组件, 直接对最终用户提供访问


## 当前部署业态现状

-   云  
    -   云励使用阿里云等IaaS平台部署的k8s环境  
        -   将全部的中间件和应用部署在该集群中
    -   对外提供SaaS服务
-   大属地  
    -   客户提供虚机/物机, 由云励运维将其搭建成k8s环境  
        -   将所需中间件/应用都部署下去
    -   目前使用该模式的核心用户  
        -   华润
-   小属地  
    -   客户提供小白机 (4C8G), 由云励运维将其部署为kubeedge的边缘节点  
        -   将所需的应用和中间件部署上去  ( 只需要部分节点)
-   手工  
    -   由项目集成同学在客户提供的机器上进行部署  
        -   手动通过bash启动服务, 推到后台等
        -   通过公网访问云励的SaaS服务
-   其他?  
    -   在裸机上跑的服务?


## 当我们部署的时候我们需要考虑哪些维度的问题

-   制品 (artifact)  
    -   默认基于容器化部署  
        -   当前我们90%的应用和中间件通过容器化进行部署
-   部署模式  
    -   云
    -   大属地
    -   小属地
    -   手工?
-   网络  
    -   对网络带宽的要求
-   安全  
    -   必须使用https
    -   使用mTLS加密授权
    -   接口防重播/频度限制
-   存储  
    -   对磁盘等持久化存储的要求
-   监控  
    -   在几个可选的监控中选择
-   服务器  
    -   容量规划  
        -   比如 4C8G
    -   对硬件的其他要求
-   配套的中间件  
    -   用户选择相对应的中间件后, 根据经验值计算出相对应的容量规划  
        -   DB
        -   MQ
        -   监控
-   成本模型  
    -   资源成本的核算  
        -   综上的对服务器的成本
    -   人力成本的核算  
        -   交付和维护这些服务的成本


## 部署清单的业务模型

-   **部署清单** 作为标准化部署领域模型的聚合根
-   围绕部署清单进行生命周期和业务流转的管理


### 部署清单业务流

-   创建  
    -   一个项目唯一包含一份部署清单  
        
        -   前端通过 **部署清单创建页面** 来进行选择  
            -   在部署清单维度下进行选择
        
        -   部署清单页, 实时预估成本 (当具备可预估的条件下)
        -   部署清单创建成功之后, 同时保持成本预算
-   审批

-   部署清单保存后, 用户可以发起申请  
    -   为了简单, 这里的审批人可以写死 ( 比较好的用户体验是创建一个钉钉里的审批流)
-   审批通过后, 部署清单流转到研发Devops团队, 进行资源的预准备  
    -   此时同步更新CMDB的资源状态

-   变更  
    -   审批通过之前 (即未流转到研发Devops团队之前), 可以进行变更
    -   审批通过之后, 变更的流程如下:  
        -   发起之前变更的撤销
        -   重新修正成新部署后发起部署清单的流程


# 售前的问题

1.  有多少个税号公司
2.  一年内大概的开票量有多少
3.  平均的的开票金额有多大
4.  在高峰的时候预计会有多少个人同时使用系统
5.  客户重的业务操作 (异步跑批类) 预计在多大的时间窗口内可以完成

1.  大致列了一下 售前可以给到的问题 (比较通用), 还需要结合各系统的业务进行设计, 然后反过来推到到子系统的相应的指标 ( tps/ throughput )
2.  最终我们需要回答系统的performants, 但是这个问题分解到每个微服务, 会有点大 (工作量比较大, 需要压测等等), 我们先凭经验整体回答一下子系统的performants ( 进项/销项/协同)

所以需要大家帮忙给一下输入:

